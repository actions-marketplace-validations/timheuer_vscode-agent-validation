# Test the action against fixtures using matrix strategy
name: Test Action

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install and build
              run: |
                  npm ci
                  npm run build

            - name: Upload built action
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/

    test-fixtures:
        needs: build
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - path: "./test/fixtures/valid"
                      name: "valid"
                      should-pass: true
                    - path: "./test/fixtures/invalid"
                      name: "invalid"
                      should-pass: false
        steps:
            - uses: actions/checkout@v6

            - name: Download built action
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Validate ${{ matrix.name }} fixtures
              id: validate
              continue-on-error: true
              uses: ./
              with:
                  path: ${{ matrix.path }}

            - name: Check result
              run: |
                  if [ "${{ matrix.should-pass }}" == "true" ]; then
                    if [ "${{ steps.validate.outputs.valid }}" != "true" ]; then
                      echo "::error::Expected ${{ matrix.name }} fixtures to pass but they failed"
                      exit 1
                    fi
                    echo "âœ… ${{ matrix.name }} fixtures passed as expected"
                  else
                    if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
                      echo "::error::Expected ${{ matrix.name }} fixtures to fail but they passed"
                      exit 1
                    fi
                    echo "âœ… ${{ matrix.name }} fixtures failed as expected"
                  fi

            - name: Generate summary
              if: always()
              run: |
                  echo "## ðŸ” ${{ matrix.name }} Fixtures" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Path | \`${{ matrix.path }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Files Validated | ${{ steps.validate.outputs.files-validated }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Valid | ${{ steps.validate.outputs.valid }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  ERRORS='${{ steps.validate.outputs.errors }}'
                  WARNINGS='${{ steps.validate.outputs.warnings }}'

                  if [ "$ERRORS" != "[]" ] && [ -n "$ERRORS" ]; then
                    echo "### Errors" >> $GITHUB_STEP_SUMMARY
                    echo "$ERRORS" | jq -r '.[] | "- **\(.ruleId)**: \(.message)"' >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                  fi

                  if [ "$WARNINGS" != "[]" ] && [ -n "$WARNINGS" ]; then
                    echo "### Warnings" >> $GITHUB_STEP_SUMMARY
                    echo "$WARNINGS" | jq -r '.[] | "- **\(.ruleId)**: \(.message)"' >> $GITHUB_STEP_SUMMARY
                  fi

    test-features:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Download built action
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Test ignore-rules option
              uses: ./
              with:
                  path: "./test/fixtures/invalid/short-description.agent.md"
                  ignore-rules: "description-quality"

            - name: Test fail-on-warning option
              id: strict-test
              continue-on-error: true
              uses: ./
              with:
                  path: "./test/fixtures/invalid/short-description.agent.md"
                  fail-on-warning: "true"

            - name: Verify strict mode failed
              run: |
                  if [ "${{ steps.strict-test.outcome }}" != "failure" ]; then
                    echo "::error::Expected strict mode to fail but it passed"
                    exit 1
                  fi
                  echo "âœ… Strict mode correctly detected warnings"
